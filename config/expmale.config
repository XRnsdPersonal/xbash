#! /bin/bash
#----------------    user info Config    ---------------------------
export userPassword=

#----------------   加载xbash的基础配置  ------------------
filePathXbashTragetBashrcConfigBase=${dirPathHomeXbashConfig}/common.config
if [[ -f $filePathXbashTragetBashrcConfigBase ]]; then
            source $filePathXbashTragetBashrcConfigBase&& export filePathXbashTragetBashrcConfigBase=$filePathXbashTragetBashrcConfigBase
else
            echo -e "\033[1;31mXbash需要的基础配置\n$filePathXbashTragetBashrcConfigBase\033[0m不存在"
            export filePathXbashTragetBashrcConfigBase=
fi

#----------------    Android Dev Env Config    ---------------------------
jdkPathOracle6=${rDirPathTools}/jdk/1.6.038
jdkPathOpen7=/usr/lib/jvm/java-7-openjdk-amd64
jdkPathOpen8=/usr/lib/jvm/java-8-openjdk-amd64
jdkPath=$jdkPathOpen8
jdkHomePath=$jdkPath
gccPath=/usr/bin/gcc-4.8

#根据android sdk 版本修改当前java sdk 配置
sdkVersion=27 # 默认使用open jdk 8
filePath=build/core/version_defaults.mk
if [[ -f "$filePath" ]]; then
        key="PLATFORM_SDK_VERSION := "
        sdkVersion=$(cat $filePath | grep "$key")
        sdkVersion=${sdkVersion//$key/}
        sdkVersion=$(echo $sdkVersion |sed s/[[:space:]]//g)
fi
while true; do case "$sdkVersion" in
24|25|26)      jdkPath=${jdkPathOpen8}/bin/java
                        jdkHomePath=$jdkPathOpen8
                       break;;   # open jdk 8
21|22|23)      jdkPath=${jdkPathOpen7}/bin/java  
                        jdkHomePath=$jdkPathOpen7
                        break;; # open jdk 7
*)                    if (( $sdkVersion>26 ));then
                            jdkHomePath=$jdkPathOpen8
                            jdkPath=${jdkPathOpen8}/bin/java
                        elif (( $sdkVersion<21 ));then
                            jdkHomePath=$jdkPathOracle6
                            jdkPath=${jdkPathOracle6}/bin/java
                        else # default
                            jdkHomePath=$jdkPathOpen8
                            jdkPath=${jdkPathOpen8}/bin/java
                        fi
                        break;;
esac;done
if [[ -f "$jdkPath" ]]&&[[ -f "${jdkPath}c" ]]; then
        echo "$(echo "$userPassword" | sudo -S -p '' echo " " > /dev/null)" >/dev/null

        if [[ -z $(update-alternatives --list java|grep $jdkPath) ]]; then
            sudo -p '' -S update-alternatives --install /usr/bin/java java $jdkPath 300
        fi
        echo "$jdkPath" | sudo -p '' -S update-alternatives --config java >/dev/null

        jdkPath=${jdkPath}c
        if [[ -z $(update-alternatives --list javac|grep $jdkPath) ]]; then
            sudo -p '' -S  update-alternatives --install /usr/bin/javac javac $jdkPath 300
        fi
        echo "$jdkPath" | sudo -p '' -S update-alternatives --config javac >/dev/null

        # gcc 版本
        # if [[ -f "$gccPath" ]]; then
        #     echo "$gccPath" | sudo -p '' -S update-alternatives --config gcc >/dev/null
        # fi
else
    echo -e "\033[1;31mJava_环境配置更新失败\n$jdkPath=$jdkPath\n\033[0m"
fi

export JAVA_HOME=$jdkHomePath
export JRE_HOME=${JAVA_HOME}/jre
export CLASSPATH=.:${JAVA_HOME}/lib:${JRE_HOME}/lib


export ANDROID_SET_JAVA_HOME=true
export ANDROID_PRE_BUILD_PATHS=$JAVA_HOME
export ANDROID_JAVA_TOOLCHAIN=$JAVA_HOME

export ANDROID_SDK=${dirPathHomeTools}/sdk_adt/5.1
export ANDROID_SDK_HOME=$ANDROID_SDK
export ANDROID_SDK_BUILD_TOOL=${ANDROID_SDK_HOME}/build-tools/android-4.4W
export ANDROID_NDK=${dirPathHomeTools}/ndk/android-ndk-r12b

export PATH=$PATH:${JAVA_HOME}/bin:${JRE_HOME}/bin
export PATH=$PATH:$ANDROID_SDK_BUILD_TOOL
export PATH=$PATH:$ANDROID_NDK
#export PATH=$PATH:/usr/local/cuda-7.5/bin:/usr/local/cuda-8.0/bin
export PATH=$PATH:${dirPathHomeTools}/sp_flash_tool_v5.1612.00.100
export PATH=$PATH:/usr/libexec/git-core
export PATH=$PATH:$dirPathHomeTools

#缓存目录[android优化加速部分]
isUseBuildCcache=true
dirPathCache=/media/cache
if [ "$isUseBuildCcache" = "true" ]&&[ -d $dirPathCache  ]; then
    dirPathCache=${dirPathCache}/.ccache
    export CCACHE_DIR=$dirPathCache
    export USE_CCACHE=1
    export CACHE_UMASK=002
    unset CCACHE_HARDLINK
fi

#分布式编译集群的IP组
# isUseDistcc=true
if [[ "$isUseDistcc" = "true" ]]; then
    export PATH=/usr/lib/distcc:$PATH
    # export WRAPPER=ccache
    # export CCACHE_PREFIX=distcc
    export DISTCC_HOSTS="localhost 192.168.1.55"
fi

#------------------------------------  部分环境错误提示  ----------------------------------
if [ ! -d "$JAVA_HOME" ];then
    echo -e "\033[1;31mJava_环境配置错误\n$JAVA_HOME不存在\n\033[0m"
fi
if [ ! -d "$ANDROID_SDK" ];then
    echo -e "\033[1;31mAndroid_SDK_环境配置错误\n$ANDROID_SDK 不存在\n\033[0m"
fi
if [ ! -d "$ANDROID_NDK" ];then
    echo -e "\033[1;31mAndroid_NDK_环境配置错误\n$ANDROID_NDK 不存在\033[0m"
fi
if [ ! -f "$rFilePathGitBash" ];then
    echo -e "\033[1;31mgit bash 配置文件:\n$rFilePathGitBash 不存在\033[0m"
else
    source $rFilePathGitBash
fi